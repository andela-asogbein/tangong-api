{"version":3,"sources":["../../src/controllers/payment.controller.js"],"names":["mailer","require","request","nodemailer","transporter","createTransport","connectionController","checkRequest","str","console","log","info","split","module","exports","checkNotification","req","res","transaction_id","body","err","response","bodyObj","JSON","parse","merchant_ref","provider_username","service","provider_email","status","message","mailOptions","from","to","subject","html","sendMail","error","add","setTimeout","redirect","referrer","gig"],"mappings":"AAAA;;AAEA,IAAIA,SAASC,QAAQ,wBAAR,CAAb;AACA,IAAIC,UAAUD,QAAQ,SAAR,CAAd;AACA,IAAIE,aAAaF,QAAQ,YAAR,CAAjB;;AAEA,IAAIG,cAAcD,WAAWE,eAAX,EAAlB;AACA,IAAIC,uBAAuBL,QAAQ,yBAAR,CAA3B;;AAEA,IAAIM,eAAe,SAAfA,YAAe,CAASC,GAAT,EAAc;AAC/BC,UAAQC,GAAR,CAAYF,GAAZ;AACA,MAAIG,OAAOH,IAAII,KAAJ,CAAU,GAAV,CAAX;AACA,SAAO;AACL,gBAAYD,KAAK,CAAL,CADP;AAEL,WAAOA,KAAK,CAAL,CAFF;AAGL,iBAAaA,KAAK,CAAL,CAHR;AAIL,gBAAYA,KAAK,CAAL,CAJP;AAKL,eAAWA,KAAK,CAAL,CALN;AAML,yBAAqBA,KAAK,CAAL,CANhB;AAOL,sBAAkBA,KAAK,CAAL;AAPb,GAAP;AASD,CAZD;;AAcAE,OAAOC,OAAP,GAAiB;AACfC,qBAAmB,2BAASC,GAAT,EAAcC,GAAd,EAAmB;;AAEpC,QAAIC,iBAAiBF,IAAIG,IAAJ,CAASD,cAA9B;AACAhB,YAAQ,4CAA4CgB,cAA5C,GAA6D,YAArE,EAAmF,UAASE,GAAT,EAAcC,QAAd,EAAwBF,IAAxB,EAA8B;AAC/G,UAAIG,UAAUC,KAAKC,KAAL,CAAWL,IAAX,CAAd;AACA,UAAIR,OAAOJ,aAAae,QAAQG,YAArB,CAAX;AACA,UAAIC,oBAAoBf,KAAKe,iBAA7B;AACA,UAAIC,UAAUhB,KAAKgB,OAAnB;AACA,UAAIC,iBAAiBjB,KAAKiB,cAA1B;AACAjB,WAAKO,cAAL,GAAsBA,cAAtB;AACA,UAAII,QAAQO,MAAR,IAAkBP,QAAQO,MAAR,KAAmB,UAAzC,EAAqD;AACnD,YAAIC,UAAU,YAAYJ,iBAAZ,GAAgC,qCAAhC,GAAwEC,OAAxE,GAAkF,WAAhG;AACA,YAAII,cAAc;AAChBC,gBAAM,wCADU;AAEhBC,cAAIL,cAFY;AAGhBM,mBAAS,eAHO;AAIhBC,gBAAM,QAAQL,OAAR,GAAkB;AAJR,SAAlB;AAMA1B,oBAAYgC,QAAZ,CAAqBL,WAArB,EAAkC,UAASM,KAAT,EAAgBhB,QAAhB,EAA0B;AAC1D,cAAIgB,KAAJ,EAAW;AACT5B,oBAAQC,GAAR,CAAY2B,KAAZ;AACD;AACD/B,+BAAqBgC,GAArB,CAAyB3B,IAAzB;AACA4B,qBAAWtB,IAAIuB,QAAJ,CAAalB,QAAQmB,QAAR,GAAmB,SAAnB,GAA+B9B,KAAK+B,GAAjD,CAAX,EAAkE,IAAlE;AACD,SAND;AAOD;AACF,KAvBD;AAwBD;AA5Bc,CAAjB","file":"payment.controller.js","sourcesContent":["'use strict';\n\nvar mailer = require(\"./mailer.controller.js\");\nvar request = require(\"request\");\nvar nodemailer = require(\"nodemailer\");\n\nvar transporter = nodemailer.createTransport();\nvar connectionController = require(\"./connection.controller\")\n\nvar checkRequest = function(str) {\n  console.log(str);\n  var info = str.split(\"-\");\n  return {\n    'provider': info[0],\n    'gig': info[1],\n    'requester': info[2],\n    'username': info[3],\n    'service': info[4],\n    'provider_username': info[5],\n    'provider_email': info[6]\n  }\n}\n\nmodule.exports = {\n  checkNotification: function(req, res) {\n\n    var transaction_id = req.body.transaction_id;\n    request(\"https://voguepay.com/?v_transaction_id=\" + transaction_id + \"&type=json\", function(err, response, body) {\n      var bodyObj = JSON.parse(body);\n      var info = checkRequest(bodyObj.merchant_ref);\n      var provider_username = info.provider_username;\n      var service = info.service;\n      var provider_email = info.provider_email;\n      info.transaction_id = transaction_id;\n      if (bodyObj.status && bodyObj.status === \"Approved\") {\n        var message = \"Hello, \" + provider_username + \" Someone has paid for your service \" + service + \" on Tango\";\n        var mailOptions = {\n          from: \"Tango Nigeria âœ” <no-reply@tangong.com>\",\n          to: provider_email,\n          subject: \"Tango Nigeria\",\n          html: \"<b>\" + message + \"</b>\"\n        }\n        transporter.sendMail(mailOptions, function(error, response) {\n          if (error) {\n            console.log(error);\n          }\n          connectionController.add(info)\n          setTimeout(res.redirect(bodyObj.referrer + \"#!/gig/\" + info.gig), 3000);\n        })\n      }\n    });\n  }\n}\n"]}