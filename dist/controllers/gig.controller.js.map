{"version":3,"sources":["../../src/controllers/gig.controller.js"],"names":["mongoose","require","formidable","cloudinary","config","cloud_name","api_key","api_secret","Gig","model","User","userController","module","exports","addImage","req","res","next","form","IncomingForm","parse","err","fields","files","body","hasOwnProperty","image","file","path","uploader","upload","result","imageUrl","url","addGig","gig","save","json","status","getGigs","find","populate","sort","exec","gigs","getRandomGigs","arr","n","length","tempArr","i","push","splice","Math","floor","random","getOneGig","findById","_id","params","gig_id","updateGig","loggedInUser","user","id","console","log","addedBy","error","update","deleteGig","remove","deleteAll","searchGigs","titleExpression","RegExp","query","title","searchCategories","category","category_id","searchUsers","user_id","uploadImage","response","img"],"mappings":"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","file":"gig.controller.js","sourcesContent":["'use strict';\n\nvar mongoose = require('mongoose');\nvar formidable = require('formidable');\nvar cloudinary = require('cloudinary');\n\nrequire(\"../models/gig.model\");\nrequire(\"../models/user.model\");\n\ncloudinary.config({\n  cloud_name: 'neddinn',\n  api_key: '358555269189826',\n  api_secret: 'jJZiRszXOelRPoIIYeIayKwzZic'\n});\n\nvar Gig = mongoose.model(\"Gig\");\nvar User = mongoose.model(\"User\");\n\nvar userController = require(\"./user.controller\");\n\nmodule.exports = {\n  addImage: function(req, res, next) {\n    var form = new formidable.IncomingForm();\n    form.parse(req, function(err, fields, files) {\n      req.body = fields;\n      if (!files.hasOwnProperty('file')) {\n        next();\n        return;\n      }\n      req.image = files.file.path;\n      cloudinary.uploader.upload(req.image, function(result) {\n        req.body.imageUrl = result.url;\n        next();\n      });\n    });\n  },\n  addGig: function(req, res) {\n    // req.body.addedBy = req.user.id;\n    var gig = new Gig(req.body);\n    gig.save(function(err, gig) {\n      if (err) {\n        return res.json(err);\n      }\n      res.status(201).json(gig);\n    });\n  },\n\n  getGigs: function(req, res) {\n    Gig.find({}).populate('addedBy category').sort(\"-dateAdded\").exec(function(err, gigs) {\n      if (err) {\n        return res.json(err);\n      }\n      res.status(200).json(gigs);\n    });\n  },\n\n    getRandomGigs: function(req, res) {\n    Gig.find({}).populate('addedBy category').sort(\"-dateAdded\").exec(function(err, gigs) {\n      if (err) {\n        return res.json(err);\n      }\n      var arr = gigs;\n      var n = arr.length;\n      var tempArr = [];\n\n      for(var i = 0; i<n-1; i++){\n        tempArr.push(arr.splice(Math.floor(Math.random()*arr.length), 1)[0]);\n      }\n      tempArr.push(arr[0]);\n      arr = tempArr;\n      res.status(200).json(arr);\n    });\n  },\n\n\n\n  getOneGig: function(req, res) {\n    Gig.findById({\n      _id: req.params.gig_id\n    }).populate('addedBy category').exec(function(err, gig) {\n      if (err) {\n        return res.json(err);\n      }\n      res.status(200).json(gig);\n    });\n  },\n\n  updateGig: function(req, res) {\n    var loggedInUser = req.user.id;\n    console.log(2, loggedInUser);\n    // req.body.addedBy = req.body.addedBy._id;\n    console.log(1, req.body.addedBy);\n    if (req.body.addedBy !== loggedInUser) {\n      console.log(\"i reach\")\n      return res.json({\n        error: \"Unauhorized\"\n      });\n    }\n    Gig.update({\n      _id: req.body._id\n    }, req.body, function(err, gig) {\n      if (err) {\n        console.log(err);\n        return res.json(err);\n      }\n      res.status(201).json(gig);\n    });\n  },\n\n  deleteGig: function(req, res) {\n    Gig.remove({\n      _id: req.params.gig_id\n    }, function(err, gig) {\n      if (err) {\n        return res.json(err);\n      }\n      res.status(200).json(gig);\n    });\n  },\n  deleteAll: function(req, res) {\n    Gig.remove({}, function(err, gig) {\n      if (err) {\n        return res.json(err);\n      }\n      res.status(200).json(gig);\n    });\n  },\n\n  searchGigs: function(req, res) {\n    var titleExpression = new RegExp(req.query.title, 'ig');\n    Gig.find({\n      title: titleExpression\n    }, function(err, gigs) {\n      if (err) {\n        return res.json(err);\n      }\n      res.status(200).json(gigs);\n    });\n  },\n\n  searchCategories: function(req, res){\n    Gig.find({category: req.params.category_id}).populate('addedBy category').exec(function(err, gigs){\n      if(err){\n        return res.json(err);\n      }\n      res.status(200).json(gigs);\n    });\n  },\n\n  searchUsers: function(req, res){\n    var user_id = req.user_id;\n    Gig.find({\n      addedBy: user_id\n    }).populate('addedBy category').exec(function(err, gigs) {\n      if (err) {\n        return res.json(err);\n      }\n      res.status(200).json(gigs);\n    });\n  },\n\n  uploadImage: function(req, res, next) {\n    if (req.files.file) {\n      var path = req.files.file.path;\n      cloudinary.uploader.upload(path, function(response) {\n        req.img = response.url;\n        next();\n      });\n    } else {\n      next();\n    }\n  }\n};\n"]}